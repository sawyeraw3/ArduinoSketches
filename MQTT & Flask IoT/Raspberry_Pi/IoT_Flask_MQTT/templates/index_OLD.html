<!DOCTYPE html>
<head>
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <title>ESP8266 Weather Data</title>
  <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
  <!-- TODO replace socket with JQuery -->
	<!-- <script type="text/javascript" charset="utf-8">
  	$(document).ready(function() {
  	  var socket = io.connect('http://' + document.domain + ':' + location.port);
  	  socket.on('dht_data_message', function(data) {
        data = JSON.parse(data['payload']);
  	    let text = `<tr><td>${data['id']}</td><td>${data['temperature']}</td><td> ${data['humidity']} </td><td> ${data['currentdate']} </td><td> ${data['currenttime']} </td><td> ${data['device']}</td></tr>`;
        $('#incomingdata').append(text);
  	  });
  	});
	</script> -->
  <script type="text/javascript" charset="utf-8">
    $(function loadDatabase(){
      window.setInterval(function(){
        $.ajax({
          type: "GET",
          url: "/api/v1/resources/dhtdata/most_recent",
          success: function(data) {
            data = data[0];
            let text = `<tr><td>${data['id']}</td><td> ${data['currentdate']} @ ${data['currenttime']} </td><td>${data['temperature']} | ${data['humidity']} </td><td> ${data['device']}</td></tr>`;
            $('#incomingdatatable tr').eq(1).after(text);
          }
        });
      }, 30000);
    });
  </script>
</head>

<body>
  <h1>ESP8266 DHT Sensor Data</h1>
  <h3>Incoming Datapoints</h3>
  <table id="incomingdatatable" class="table table-hover">
    <tr><th>Entry ID</th>
    <th>Date @ Time (Received)</th>
    <th>Temperature (&#8457) | Humidity (%)</th>
    <th>Origin Device</th></tr>
    <tr></tr>
  </table>
  <h3>Previous 20 Datapoints</h3>
  <table id="datatable" class="table table-hover">
    <tr><th>Entry ID</th>
    <th>Date @ Time (Received)</th>
    <th>Temperature (&#8457) | Humidity (%)</th>
    <th>Origin Device</th></tr>
    {% for entry in dht_readings %}
      <tr><td>{{ entry.id }}</td>
      <td>{{ entry.currentdate }} @ {{ entry.currenttime }}</td>
      <td>{{ entry.temperature }} | {{ entry.humidity }}</td>
      <td>{{ entry.device }}</td></tr>
    {% endfor %}
  </table>
</body>
</html>